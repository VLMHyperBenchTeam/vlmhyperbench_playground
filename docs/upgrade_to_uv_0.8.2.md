# Инструкция по обновлению до uv 0.8.2

Данный документ описывает пошаговый процесс обновления проекта `vlm-hyperbench` с версии `uv` 0.7.18 до версии 0.8.2. Обновление включает в себя критические изменения, поэтому важно следовать инструкциям внимательно.

## 1. Подготовка

Перед началом обновления необходимо выполнить следующие шаги для обеспечения безопасности и возможности отката.

### 1.1. Резервное копирование
Создайте новую ветку для обновления, чтобы изолировать изменения и иметь возможность легко откатиться в случае проблем.

```bash
git checkout -b upgrade/uv-0.8.2
```

### 1.2. Обновление самого uv
Убедитесь, что на вашей машине установлена последняя версия `uv` (0.8.2). Выполните команду обновления:

```bash
# Для установки через pipx
pipx upgrade uv

# Или через pip
pip install --upgrade uv

# Проверка версии
uv --version
# Ожидаемый вывод: uv 0.8.2
```

## 2. Анализ и адаптация под критические изменения

Версия `uv` 0.8.0 внесла несколько критических изменений, которые могут повлиять на ваш workflow. Ниже приведены ключевые изменения и необходимые действия.

### 2.1. Поведение команды `uv version`
*   **Изменение:** Команда `uv version` больше не отображает версию самого `uv` при запуске вне проекта. Теперь для этого следует использовать `uv self version`.
*   **Действие:** Проверьте все скрипты, документацию и CI/CD конфигурации на наличие команды `uv version`. Замените их на `uv self version`.
    *   **Где искать:** `docs/docs_new/03_environment_setup.md`, `docs/docs_new/07_docker_deployment.md`, `build_docker.py`, `.github/workflows/` (если есть).

### 2.2. Поведение команды `uv python pin --rm`
*   **Изменение:** Теперь для удаления глобальной привязки Python (глобального `pin`) требуется явно указать флаг `--global`.
*   **Действие:** Проверьте, нет ли в скриптах команды `uv python pin --rm`. Если есть, обновите ее до `uv python pin --global --rm`.
    *   **Где искать:** `docs/docs_new/03_environment_setup.md`, `build_docker.py`, CI/CD конфигурации.

### 2.3. Сборочный бэкенд по умолчанию
*   **Изменение:** В `uv init` теперь по умолчанию используется `uv_build` вместо `hatchling`.
*   **Действие:** **В вашем проекте НЕ ТРЕБУЕТСЯ изменений.** Поскольку вы явно указываете `hatchling` в секции `[build-system]` вашего `pyproject.toml`, `uv` будет продолжать использовать его. Это изменение касается только новых проектов, создаваемых через `uv init`.

## 3. Тестирование в dev-режиме

После подготовки выполните полную установку в dev-режиме, чтобы проверить совместимость.

### 3.1. Очистка старого окружения
Удалите существующее виртуальное окружение и lock-файл, чтобы начать с чистого листа.

```bash
# Удаление виртуального окружения
rm -rf .venv

# Удаление lock-файла
rm uv.lock
```

### 3.2. Установка и синхронизация
Выполните стандартные команды для настройки dev-окружения.

```bash
# Фиксация версии Python
uv python pin 3.12

# Установка зависимостей с выбранным CUDA-бэкендом
uv sync --extra cu124
```

### 3.3. Проверка ключевых функций
*   **Рабочие области (Workspaces):** Убедитесь, что все пакеты из `packages/*` (например, `bench-utils`, `model-interface`) успешно установлены в editable-режиме. Запустите тестовый импорт:
    ```bash
    uv run python -c "from bench_utils import metrics; print('bench_utils imported')"
    ```
*   **Запуск скриптов:** Попробуйте запустить один из основных скриптов проекта.
    ```bash
    uv run python check_classification.py
    ```
*   **Docker-сборка:** Если возможно, выполните сборку dev-образа, чтобы убедиться, что процесс не нарушается.
    ```bash
    docker build -f docker/Dockerfile-uv --target dev -t vlm-hyperbench:dev-test .
    ```

## 4. Тестирование staging и prod-режимов

После успешного тестирования в dev-режиме, проверьте staging и prod-окружения.

### 4.1. Staging-режим
```bash
# Пересчет lock-файла для staging
uv lock --project staging

# Установка окружения строго по lock-файлу
uv sync --project staging --frozen --extra cu124
```

### 4.2. Prod-режим
```bash
# Пересчет lock-файла для prod
uv lock --project prod

# Установка окружения строго по lock-файлу
uv sync --project prod --frozen --extra cu124
```

## 5. Обновление документации

После успешного тестирования всех режимов, обновите документацию, чтобы отразить изменения.

*   В `docs/docs_new/03_environment_setup.md` замените все упоминания `uv version` на `uv self version`.
*   При необходимости, добавьте примечание о новом поведении `uv python pin --rm` в раздел "Частые проблемы".

## 6. Завершение

Если все тесты пройдены успешно:
1.  Закоммитьте изменения (включая обновленную документацию).
2.  Создайте Pull Request из ветки `upgrade/uv-0.8.2` в основную ветку.
3.  После ревью и мержа, уведомите команду об обновлении.