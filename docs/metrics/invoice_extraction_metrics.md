# Методология оценки качества извлечения данных из счетов

Данный документ описывает подход к оценке качества структурного вывода модели для извлечения информации из счетов. Методология основана на комбинации метрик, позволяющих оценить точность на разных уровнях: от отдельных символов до целых позиций в счете.

## Общая стратегия оценки

Оценка качества извлечения данных осуществляется по двухуровневой схеме:
1. **Оценка отдельных полей** - анализ точности извлечения каждого поля документа
2. **Оценка структуры документа** - анализ правильности извлечения списка позиций (items) и их количества

## Метрики для оценки отдельных полей

### Character Error Rate (CER)

Для оценки степени правильности извлечения каждого поля используется метрика CER (Character Error Rate), которая рассчитывается как:

```
CER = (S + D + I) / N
```

где:
- S - количество подстановок (substitutions)
- D - количество удалений (deletions)
- I - количество вставок (insertions)
- N - общее количество символов в эталонном тексте

### Пороговая обработка CER

Для преобразования непрерывной метрики CER в бинарное решение о правильности извлечения поля вводится пороговое значение. В нашем случае рекомендуется использовать порог **15%**:

- Если CER ≤ 15%: поле считается **правильно извлеченным**
- Если CER > 15%: поле считается **неправильно извлеченным**

## Метрики для оценки позиций (items)

### Оценка полей внутри позиций

Каждая позиция в счете оценивается аналогично основным полям документа:
1. Для каждого поля позиции (name, quantity, unit, price, amount) рассчитывается CER
2. На основе порога CER (15%) определяется, правильно ли извлечено каждое поле

### F1-мера для позиций

Для оценки качества извлечения всей позиции в целом используется F1-мера, которая рассчитывается на основе precision и recall для полей позиции:

```
Precision = Правильно извлеченные поля / Все извлеченные поля
Recall = Правильно извлеченные поля / Все эталонные поля
F1 = 2 * (Precision * Recall) / (Precision + Recall)
```

### Порог по F1-мере для позиций

Вводится порог по F1-мере для определения, считать ли позицию распознанной:
- Если F1 ≥ 0.85: позиция считается **успешно распознанной**
- Если F1 < 0.85: позиция считается **не распознанной**

## Комплексные метрики

### Item Count Accuracy

Метрика оценивает точность определения количества позиций в счете:

```
Item Count Accuracy = (Количество счетов с правильным количеством распознанных позиций) / (Общее количество счетов)
```

Где "правильное количество распознанных позиций" - это количество позиций, прошедших порог по F1-мере (≥ 0.85), совпадающее с эталонным количеством позиций.

### Общие метрики качества

На основе бинарной классификации полей и позиций рассчитываются следующие метрики:
- **Accuracy** - общая точность извлечения
- **Precision** - точность (отношение правильно извлеченных элементов к общему числу извлеченных)
- **Recall** - полнота (отношение правильно извлеченных элементов к общему числу эталонных элементов)
- **F1-score** - гармоническое среднее между precision и recall

## Рекомендации по применению

1. Метрика CER с порогом 15% позволяет учитывать незначительные ошибки распознавания, не приводящие к искажению смысла.
2. Порог F1 ≥ 0.85 для позиций обеспечивает высокое качество извлечения, при котором большинство полей позиции распознаны правильно.
3. Item Count Accuracy является критически важной метрикой, так как ошибки в количестве позиций могут иметь серьезные финансовые последствия.
4. Рекомендуется отслеживать все метрики в динамике для выявления тенденций и проблем в работе модели.