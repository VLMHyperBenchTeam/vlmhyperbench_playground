# Задача 7: Реализация Data Layer (Smart Sync)

## Цель
Обеспечить эффективный доступ к данным (датасетам, изображениям) для всех этапов пайплайна, реализуя стратегию гибридного доступа (ADR-004).

## Контекст
См. [ADR-004: Smart Sync](../docs_site/docs/architecture/adr/004-smart-sync.md).
Модели требуют быстрого доступа к файлам (Local I/O). В кластерной среде или при использовании S3 прямое чтение по сети может быть узким местом.

## Подзадачи

1.  **Абстракция Storage Interface**:
    *   Создать пакет `packages/data_layer`.
    *   Определить интерфейс `StorageProvider` (методы `download`, `upload`, `exists`, `list`).
    *   Реализовать провайдеры: `LocalStorage` (прямой доступ к FS) и `S3Storage` (через `boto3`/`minio`).

2.  **Smart Sync Manager**:
    *   Реализовать логику синхронизации "перед запуском" (Sync-before-Run).
    *   Метод `ensure_dataset_available(dataset_name, local_path)`:
        *   Проверяет наличие данных локально.
        *   Если нет — скачивает из S3 (с поддержкой прогресс-бара и resume download).
        *   Проверяет целостность (опционально, checksum).

3.  **Интеграция с Оркестратором**:
    *   Перед запуском контейнера инференса оркестратор должен вызывать `SmartSyncManager` для подготовки тома с данными.
    *   Монтирование подготовленной локальной директории в Docker-контейнер (`-v /local/cache:/data`).

4.  **Artifact Management**:
    *   Логика загрузки результатов (`answers.csv`, `metrics.csv`, `report.md`) обратно в S3 после завершения этапа (для долгосрочного хранения и доступа из Dashboard).

## Ожидаемый результат
*   Пакет `data_layer`, умеющий прозрачно работать с локальной ФС и S3.
*   Оркестратор гарантирует наличие данных на диске перед стартом контейнера.
*   Результаты экспериментов надежно сохраняются в объектное хранилище (если настроено).